<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <!-- style -->
    <link rel="stylesheet" href="./style/index.css" />
    <link rel="stylesheet" href="../node_modules/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" href="./style/nav.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.8.0/css/tachyons.min.css" />
    <link rel="stylesheet" href="./style/webView.css" />
    <script src="https://kit.fontawesome.com/ea3fb95b41.js" crossorigin="anonymous"></script>

    <!-- blockly -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="../node_modules/blockly/blockly_compressed.js"></script>
    <script src="../node_modules/blockly/blocks_compressed.js"></script>
    <script src="../node_modules/blockly/msg/en.js"></script>
    <script src="../node_modules/blockly/javascript.js"></script>
    <script src="../node_modules/blockly/javascript_compressed.js"></script>
    <!-- <script>
      window.nodeRequire = require;
      delete window.require;
      delete window.exports;
      delete window.module;
    </script> -->
    <!-- custom block -->
    <script src="./blocks/Action.js"></script>
    <script src="./blocks/File.js"></script>
    <script src="./blocks/ID_Element.js"></script>
    <script src="./blocks/Logic.js"></script>
    <script src="./blocks/Loop.js"></script>
    <script src="./blocks/Starting-Ending.js"></script>
    <script src="./blocks/URL.js"></script>
    <script src="./blocks/Variables.js"></script>
    <script src="./blocks/XML.js"></script>
    <script src="./blocks/Expect.js"></script>

    <script src="./blocks/Advance/Text.js"></script>
    <script src="./blocks/Advance/Math.js"></script>
    <script src="./blocks/Advance/Time.js"></script>
    <script src="./blocks/Advance/Console.js"></script>
    <script src="./blocks/Advance/Array.js"></script>
    <!-- <script src="./blocks/variables.js"></script>
    <script src="./blocks/variables_dynamic.js"></script> -->
    <script src="./script/custom_renderer.js"></script>


    <!-- codemirror -->
    <script src="../node_modules/codemirror/lib/codemirror.js"></script>
    <script src="../node_modules/codemirror/mode/javascript/javascript.js"></script>
    <script>
        var codeTosave;
        const cypress = require("cypress");
        // const electron = require('electron');
        // const ipcRenderer = electron.ipcRenderer;

        // ipcRenderer.on('cpu',(event,data)=>{
        //     console.log('cpu %' + data);
        // });
        // ipcRenderer.on('mem',(event,data)=>{
        //     console.log('mem %' + data);
        // });
        // ipcRenderer.on('total-mem',(event,data)=>{
        //     console.log('total mem GB' + data);
        // });
    </script>

</head>
<!-- Body  -->

<body>

    <div class="app-bar">
        <nav class="tool-bar">
            <button class="w3-bar-item w3-button">
          <img id="NewFile" src="assets/image/NewFile.svg" />
        </button>
            <button class="w3-bar-item w3-button" onclick="openFile()">
          <img id="Import" src="assets/image/Import.svg"  />
        </button>
            <button class="w3-bar-item w3-button" onclick="toXML()">
          <img id="Save" src="assets/image/Save.svg"  />
        </button>
            <!-- <script src="./script/saveFile.js"></script> -->
            <button class="w3-bar-item w3-button">
          <img id="RecordWeb" src="assets/image/Recorder.svg" />
        </button>
            <button class="w3-bar-item w3-button" onclick="toSpecFile()">
          <img id="Run" src="assets/image/Run.svg"  />
        </button>
        </nav>
    </div>

    <div class="main">
        <div class="layout-container">
            <div class="workspace-container">
                <div id="blocklyDiv"></div>
            </div>
            <div class="output">
                <div class="webview-container">
                    <div class="input-web">
                        <input class="f6 f5-l input-reset bn fl black-80 bg-white pa3 lh-solid w-60 w-75-m w-80-l br2-ns br--left-ns" value="https://www.github.com" type="url" id="URL" />
                        <button class="f6 f5-l button-reset fl pv3 tc bn bg-black hover-bg-green white pointer w-100 w-25-m w-20-l br2-ns br--right-ns" type="submit" id="submit" onclick="getUrl()">
                <i class="fa-solid fa-magnifying-glass"></i>
                search
              </button>
                    </div>
                    <div class="webview-c">
                        <webview id="foo" src="https://www.github.com" preload="script/selector.js" disableguestresize></webview>
                    </div>
                    <div class="selector-container" id="selector-container">
                        <button id="selector-button" value="selector : OFF" class="selector w3-button w3-border" style="background-color: #EEEEFA ;" onclick="Buttontoggle();">
                            <img id="selector-img" src="./assets/image/Selector.svg" width="23" />
                            selector
                        </button>

                        <script>
                            function getUrl() {
                                let message = document.getElementById("URL").value;

                                console.log(message);
                                //check url
                                if (message.includes("http\:\/\/", 0)) {
                                    document.getElementById("foo").src = message;
                                    document.getElementById("URL").value = message;
                                } else if (message.includes("https\:\/\/", 0)) {
                                    document.getElementById("foo").src = message;
                                    document.getElementById("URL").value = message;
                                    //   this.url = message;
                                    //   this.message = message;
                                } else {
                                    let suffix = "https\:\/\/";
                                    document.getElementById("foo").src = suffix.concat(message);
                                    document.getElementById("URL").value = suffix.concat(message);
                                }
                                // this.message = this.url;
                            }
                        </script>
                        <!-- </input> -->
                    </div>
                </div>
                <div class="codeDiv">
                    <textarea id="showCode"></textarea>
                    <script type="text/javascript" src="./script/showcode.js"></script>
                </div>
            </div>
        </div>
    </div>
</body>
<xml id="starter">
    <block type="_001" x="88" y="88">
        <value name="DESCRIBE_TEXT">
            <shadow type="text">
                <field name="TEXT"></field>
            </shadow>
        </value>
    </block>
</xml>

<script src="./script/getElement.js"></script>
<script>
    console.log('gg')
    let fileHandle;
    var workspace = Blockly.inject("blocklyDiv", {
        comments: true,
        collapse: true,
        disable: true,
        grid: {
            spacing: 25,
            length: 3,
            colour: "#ccc",
            snap: true,
        },
        horizontalLayout: false,
        maxBlocks: Infinity,
        maxInstances: {
            test_basic_limit_instances: 3,
        },
        maxTrashcanContents: 256,
        // media: '../media/',
        oneBasedIndex: true,
        readOnly: false,
        //rtl: rtl,
        move: {
            scrollbars: true,
            drag: true,
            wheel: false,
        },
        toolbox: codelabToolbox1,
        toolboxPosition: "start",
        renderer: "custom_renderer",
        zoom: {
            controls: true,
            wheel: true,
            startScale: 1.0,
            maxScale: 4,
            minScale: 0.25,
            scaleSpeed: 1.1,
        },
    });
    Blockly.Xml.domToWorkspace(document.getElementById("starter"), workspace);
    // Variable function

    workspace.registerButtonCallback(
        "createNumberVariableButtonPressed",
        () => {
            const name = window.prompt("Enter Variable :");
            if (name && name !== "") {
                workspace.createVariable(name, ["Number", "String"]);
            }
        }
    );

    workspace.registerToolboxCategoryCallback("VARIABLE", (workspace) => {
        const xmlStringList = [
            '<button text="Add Variable" callbackKey="createNumberVariableButtonPressed"></button>',
        ];

        const Variables = workspace.getVariablesOfType(["Number", "String"]);

        if (Variables.length > 0) {
            let field =
                '<field name="VAR" id="' +
                Variables[0].getId() +
                '" variabletype="Number"></field>';
            xmlStringList.push('<block type="variables_set">' + field + "</block>");
            for (const Variable of Variables) {
                field =
                    '<field name="VAR" id="' +
                    Variable.getId() +
                    '" variabletype="Number"></field>';
                xmlStringList.push(
                    '<block type="variables_get">' + field + "</block>"
                );
            }
        }

        const xmlElementList = xmlStringList.map((item) => {
            return Blockly.Xml.textToDom(item);
        });
        return xmlElementList;
    });


    // Variable function

    function myUpdateFunction() {
        var code = Blockly.JavaScript.workspaceToCode(workspace);
        //codeArea is in showcode.js
        codeArea.getDoc().setValue(code);
        codeTosave = code;
    }
    workspace.addChangeListener(myUpdateFunction);

    function runFile() {
        var path = require("path");
        console.log("in running process !!");
        cypress
            .run({
                // the path is relative to the current working directory
                headed: true,
                spec: "./cypress/integration/test1.spec.js",
                exit: false,
            })
            .then((results) => {
                console.log(results);
            })
            .catch((err) => {
                console.error(err);
            });
    }

    function toSpecFile() {
        const path = require("path");
        const fs = require("fs");
        fs.writeFile(
            "./cypress/integration/test1.spec.js",
            codeTosave,
            function(err) {
                if (err) {
                    throw err;
                    console.log("Cancelled");
                } else {
                    console.log("Saved!");
                    runFile();
                    //alert("Successfully Saved !");
                }
            }
        );
    }

    function download(data, filename, type) {
        var file = new Blob([data], {
            type: type,
        });
        if (window.navigator.msSaveOrOpenBlob) {
            // IE10+
            console.log("HA1");
            window.navigator.msSaveOrOpenBlob(file, filename);
        } else {
            // Others
            var a = document.createElement("a"),
                url = URL.createObjectURL(file);
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            console.log("HA2");
            setTimeout(function() {
                console.log("HA3");
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }
        console.log(filename);
    }

    async function openFile() {
        [fileHandle] = await window.showOpenFilePicker({
            types: [{
                description: "XML",
                accept: {
                    "text/xml": [".xml"],
                },
            }, ],
            excludeAcceptAllOption: true,
            multiple: false,
        });
        let fileData = await fileHandle.getFile();
        let text = await fileData.text();
        var xml = Blockly.Xml.textToDom(text);
        Blockly.Xml.domToWorkspace(xml, workspace);
    }

    // async function save() {
    //     let stream = await fileHandle.createWritable();
    //     console.log('st1')
    //     var xml = Blockly.Xml.workspaceToDom(workspace);
    //     console.log('st2')
    //     await stream.write(xml);
    //     console.log('st3')
    //     await stream.close();
    // }

    // async function saveAs() {
    //     console.log('st0.1')
    //     fileHandle = await window.showSaveFilePicker();
    //     console.log('st0.2')
    //     let stream = await fileHandle.createWritable();
    //     var xml = Blockly.Xml.workspaceToDom(workspace);
    //     console.log('st2')
    //     await stream.write(xml);
    //     console.log('st3')
    //     await stream.close();
    //     //save();
    // }

    function toXML() {
        const {
            ipcRenderer
        } = require('electron');
        var xml = Blockly.Xml.workspaceToDom(workspace);
        document.getElementById("Save").value = xml;
        console.log("Hi XML");
        console.log(document.getElementById("Save").value);
        var xmlText = Blockly.Xml.domToPrettyText(xml);
        ipcRenderer.send('xmlData', xmlText)
            // console.log(xmlText);
            // const path = require("path");
            // const fs = require("fs");
            // fs.writeFile(
            //     path.join(__dirname, "../script.xml"),
            //     xmlText,
            //     function(err) {
            //         if (err) {
            //             throw err;
            //             console.log("Cancelled");
            //         } else {
            //             console.log("Saved!");
            //             // runFile();
            //             //alert("Successfully Saved !");
            //         }
            //     }
            // );
            // download(xmlText, "script.xml", "text/xml");
    }
    var interval;
    var webView = document.querySelector("webview");

    function Buttontoggle() {
        var selector = document.getElementById("selector-button");
        // var webView = document.querySelector("webview");
        console.log(webView.getURL())
        if (selector.value == 'selector : OFF') {
            selector.setAttribute("style", "background-color:#00ACB8");
            selector.value = 'selector : ON';
            console.log('Button status : ', selector.value)
            getEle()
        } else if (selector.value == 'selector : ON') {
            selector.setAttribute("style", "background-color::#EEEEFA");
            selector.value = 'selector : OFF';
            console.log('Buuton status : ', selector.value)
            removeEle()
        }

    }

    function removeEle() {

        webView.send("get_element", 'stop');
        console.log('--- Stop selector----');
        clearInterval(interval)

    }

    function getEle() {
        let element = {
            id: '',
            status: 'wait_element'
        }
        webView.send("get_element", 'get');
        // var webView = document.querySelector("webview");
        webView.addEventListener("ipc-message", (chennel, args) => {
            element.id = chennel.args[0];
            element.status = chennel.args[1]
        });

        console.log('----Start selector----')

        interval = window.setInterval(function() {
            if (element.status === 'return_element') {
                var xmlText = `
                <xml>
                    <block type="_027" x="100" y="100">
                        <field name="ID_ELE">` + element.id + `</field>
                    </block>
                </xml>`
                var xml = Blockly.Xml.textToDom(xmlText);
                Blockly.Xml.domToWorkspace(xml, workspace);
                console.log('Test : ', element.id)
                element.status = 'wait_element'
            }
        }, 100);
    }
</script>

</html>