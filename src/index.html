<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <!-- style -->
  <link rel="stylesheet" href="index.css" />
  <link rel="stylesheet" href="../node_modules/codemirror/lib/codemirror.css" />
  <link rel="stylesheet" href="./style/nav.css" />
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

  <!-- blockly -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="../node_modules/blockly/blockly_compressed.js"></script>
  <script src="../node_modules/blockly/blocks_compressed.js"></script>
  <script src="../node_modules/blockly/msg/en.js"></script>
  <script src="../node_modules/blockly/javascript.js"></script>
  <script src="../node_modules/blockly/javascript_compressed.js"></script>
  <!-- <script>
      window.nodeRequire = require;
      delete window.require;
      delete window.exports;
      delete window.module;
    </script> -->

  <!-- custom block -->
  <script src="./blocks/Action.js"></script>
  <script src="./blocks/File.js"></script>
  <script src="./blocks/ID_Element.js"></script>
  <script src="./blocks/Logic.js"></script>
  <script src="./blocks/Loop.js"></script>
  <script src="./blocks/Starting-Ending.js"></script>
  <script src="./blocks/URL.js"></script>
  <script src="./blocks/Advance/Text.js"></script>
  <script src="./blocks/Advance/Math.js"></script>
  <script src="./blocks/XML.js"></script>
  <script src="./script/custom_renderer.js"></script>

  <!-- codemirror -->
  <script src="../node_modules/codemirror/lib/codemirror.js"></script>
  <script src="../node_modules/codemirror/mode/javascript/javascript.js"></script>
  <script type="text/javascript">
    var codeTosave 
  </script>

  <!-- <script src="./main.js"></script> -->
</head>

<body>
  <div class="app-bar">
    <nav class="tool-bar">
      <button class="w3-bar-item w3-button w3-border"><img id="NewFile" src="assets/image/NewFile.png" /></button>
      <button class="w3-bar-item w3-button w3-border"><img id="Import" src="assets/image/Import.png" /></button>
      <button class="w3-bar-item w3-button w3-border"><img id="Save" src="assets/image/Save.png" onclick="saveFile()" /></button>
      <button class="w3-bar-item w3-button w3-border"><img id="RecordWeb" src="assets/image/RecordWeb.png" /></button>
      <button class="w3-bar-item w3-button w3-border"><img id="Run" src="assets/image/Run.png" onclick="runFile()"/></button>
      <script>
        function runFile(){
          const { exec } = require('child_process');
          exec(`cypress run --spec "cypress/integration/test1.spec.js"`)
        };
      </script>
    </nav>
  </div>

  <div class="main">
    <div class="layout-container">
      <div class="workspace-container">
        <div id="blocklyDiv"></div>

      </div>
      <div class="output">
        <div class="webview">
          <webview id="foo" src="https://www.github.com/" style="display:inline-flex; width:640px; height:480px">
          </webview>
        </div>
        <div class="codeDive">
          <textarea id="showCode"></textarea>
          <script type="text/javascript" src="./script/showcode.js"></script>
        </div>
      </div>
    </div>
  </div>
</body>
<!-- <script type="text/javascript" src="./script/saveFile.js"></script> -->
<footer>5</footer>

<script>
  // var {download} = require('main.js');
  var workspace = Blockly.inject("blocklyDiv", {
    comments: true,
    collapse: true,
    disable: true,
    grid: {
      spacing: 25,
      length: 3,
      colour: "#ccc",
      snap: true,
    },
    horizontalLayout: false,
    maxBlocks: Infinity,
    maxInstances: {
      test_basic_limit_instances: 3
    },
    maxTrashcanContents: 256,
    // media: '../media/',
    oneBasedIndex: true,
    readOnly: false,
    //rtl: rtl,
    move: {
      scrollbars: true,
      drag: true,
      wheel: false,
    },
    toolbox: codelabToolbox1,
    toolboxPosition: "start",
    renderer: 'custom_renderer',
    zoom: {
      controls: true,
      wheel: true,
      startScale: 1.0,
      maxScale: 4,
      minScale: 0.25,
      scaleSpeed: 1.1,
    },
  });

  function myUpdateFunction() {
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    //codeArea is in showcode.js
    codeArea.getDoc().setValue(code);
    codeTosave = code;
  }
  workspace.addChangeListener(myUpdateFunction);

  function saveFile(){
    const path = require('path');
    const fs = require("fs");
    fs.writeFile(path.join(__dirname, '../cypress/integration/test1.spec.js'), 
                 codeTosave, function (err) {
        if (err){
          throw err
        alert("Cancelled");;
        }
        else{
          console.log('Saved!');
        alert("Successfully Saved !");
        }
        
    });

    // var result = download(codeTosave);
    // if(result===true){
    //   alert("Successfully Saved !");
    // }
    // else{
    //   alert("Cancelled");
    // }
  }
</script>

</html>